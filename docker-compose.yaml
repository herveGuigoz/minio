version: '3.2'

services:
  traefik:
    image: traefik:v2.9
    container_name: traefik
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - $PWD/traefik:/etc/traefik
      - $PWD/traefik/traefik.log:/traefik.log
      - $PWD/traefik/acme.json:/acme.json
    networks:
      - traefik_public
    ports:
      - target: 80
        published: 80
        protocol: tcp
      - target: 443
        published: 443
        protocol: tcp
    labels: 
      traefik.http.middlewares.auth.basicauth.users: ${USER}
      # Dashboard available at `traefik.$DOMAIN_NAME/dashboard`
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.rule: Host(`traefik.${DOMAIN_NAME}`)
      traefik.http.routers.dashboard.entrypoints: https
      traefik.http.routers.dashboard.tls: true
      traefik.http.routers.dashboard.middlewares: auth

  minio:
    image: minio/minio
    container_name: minio
    volumes:
     - $PWD/minio:/data
    networks:
      - traefik_public
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # Redirect web browsers to this URL when they hit the API directly.
      MINIO_BROWSER_REDIRECT_URL: https://minio-console.${DOMAIN_NAME}
      MINIO_SERVER_URL: https://minio.${DOMAIN_NAME}
    command: server --console-address ":9001" /data
    labels:
      traefik.enable: true
      # MINIO API
      traefik.http.routers.minio.service: minio
      traefik.http.services.minio.loadbalancer.server.port: 9000
      traefik.http.routers.minio.rule: Host(`minio.${DOMAIN_NAME}`)
      traefik.http.routers.minio.entrypoints: https
      # MINIO CONSOLE
      traefik.http.routers.minio-console.service: minio-console
      traefik.http.services.minio-console.loadbalancer.server.port: 9001
      traefik.http.routers.minio-console.rule: Host(`minio-console.${DOMAIN_NAME}`)
      traefik.http.routers.minio-console.entrypoints: https

networks:
  traefik_public:
    name: traefik_public
    external: true